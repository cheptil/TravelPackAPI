# Полный анализ API Musement Partner

## Исполнительное резюме

В ходе изучения API документации Musement Partner и попыток тестирования были получены следующие ключевые выводы:

1. **API требует обязательной аутентификации** - все эндпоинты защищены OAuth 2.0
2. **Доступ предоставляется только после подписания контракта** с командой Strategic partnerships
3. **API хорошо документирован** с подробными примерами и спецификациями
4. **Поддерживаются два типа интеграции**: Merchant и Affiliate
5. **Sandbox среда доступна только авторизованным партнерам**

## Детальный анализ документации

### Архитектура API

**Базовый URL**: 
- Sandbox: `https://sandbox-api.musement.com` (приватный)
- Production: `https://api.musement.com` (приватный)

**Версия API**: 3.4.0

**Протокол аутентификации**: OAuth 2.0 с Client Credentials flow

### Обязательные заголовки

Все запросы к API должны содержать следующие заголовки:

```http
X-Musement-Application: {applicationValue}
X-Musement-Version: 3.4.0
Content-Type: application/json
Authorization: Bearer {accessToken}  # для аутентифицированных запросов
```

### Процесс аутентификации

#### 1. Получение access token

**Эндпоинт**: `POST /login`

**Параметры запроса**:
```json
{
  "client_id": "{clientId}",
  "client_secret": "{clientSecret}",
  "grant_type": "client_credentials"
}
```

**Ответ**:
```json
{
  "access_token": "0GYzMGM5YjEyZjkzYzI0MGUON2Y4NDdmZm1MjVhYTkzNTY5NWhYTzmNGIzNzIxZTFhZjg3NzYyGYYQ",
  "expires_in": 3600,
  "token_type": "bearer",
  "scope": null
}
```

#### 2. Использование токена

Полученный `access_token` используется во всех последующих запросах в заголовке `Authorization: Bearer {token}`.

**Важно**: Токены истекают через 3600 секунд (1 час).

## Основные эндпоинты API

### Catalog (Каталог)

#### Activities (Активности)
- `GET /activities` - Поиск активностей
- `GET /activities/{activityUuid}` - Получение информации об активности
- `GET /activities/{activityUuid}/bundles` - Получение пакетов для активности
- `GET /activities/{activityUuid}/translation` - Получение переводов активности
- `GET /activities/{activityUuid}/country` - Получение страны активности
- `GET /activities/{activityUuid}/dates` - Поиск дат в активности
- `GET /activities/{activityUuid}/dates/{date}` - Получение расписания для даты
- `GET /activities/{activityUuid}/cities` - Получение городов для активности
- `GET /activities/{activityUuid}/flavours` - Получение вариантов активности

#### Другие разделы каталога
- `GET /categories` - Категории активностей
- `GET /cities` - Города
- `GET /countries` - Страны
- `GET /venues` - Места проведения

### Booking Flow (Процесс бронирования)

- `GET /searching-activities` - Поиск активностей для бронирования
- `GET /activity-info` - Информация об активности
- `GET /pickups` - Точки сбора
- `GET /dates` - Доступные даты
- `POST /carts` - Создание корзины
- `POST /customer-info` - Информация о клиенте
- `POST /orders` - Создание заказа
- `POST /payments` - Обработка платежей
- `DELETE /cancellations` - Отмена бронирований

## Параметры поиска активностей

API поддерживает богатый набор параметров для фильтрации активностей:

### Временные фильтры
- `available_from` - фильтр по доступным датам (от)
- `available_to` - фильтр по доступным датам (до)

### Географические фильтры
- `city_in` - массив ID городов
- `coordinates` - фильтр по координатам (широта, долгота)

### Категориальные фильтры
- `category_in` - массив кодов категорий
- `available_language_in` - массив языковых кодов

### Пагинация
- `limit` - количество результатов на страницу
- `offset` - смещение для пагинации

## Типы интеграции

### Merchant Integration

**Характеристики**:
- Партнер выступает как "merchant of record"
- Полная интеграция с API Musement
- Использование "no-payment" flow
- Партнер управляет всеми платежными операциями
- Требует специальной авторизации

**Обязанности партнера**:
- Расчет и применение налогов по странам
- Обработка всех денежных транзакций с клиентами
- Предоставление клиентской поддержки
- Обработка отмен и возвратов
- Управление коммуникацией между поставщиками и клиентами

### Affiliate Integration

**Характеристики**:
- Musement выступает как "merchant of record"
- Использование "payment flow" через Stripe
- Два варианта: полная или частичная интеграция

**Полная интеграция**:
- Весь пользовательский опыт на платформе партнера
- Платежи через API Musement

**Частичная интеграция**:
- Интеграция только API поиска каталога
- Перенаправление на платформу Musement для оплаты

## Процесс получения доступа

### Пошаговый план

1. **Подписание контракта**
   - Контакт: business@musement.com
   - Команда: Strategic partnerships

2. **Получение sandbox доступа**
   - Команда API distribution предоставляет:
     - Sandbox authentication credentials
     - Application value

3. **Тестирование в sandbox**
   - Изучение sandbox среды
   - Тестирование интеграции

4. **Запрос production доступа**
   - Обращение к Strategic partnerships и API distribution

5. **Выполнение go-live checklist**
   - Соответствие требованиям quality checklist

6. **Демонстрация интеграции**
   - Организация демо с командами Musement

7. **Получение production доступа**
   - Получение production credentials и application value

## Результаты тестирования

### Попытки подключения

В ходе тестирования были предприняты следующие попытки:

1. **Проверка sandbox API** (`https://sandbox-api.musement.com`)
   - **Результат**: Домен не резолвится публично
   - **Вывод**: Sandbox доступен только авторизованным партнерам

2. **Проверка production API** (`https://api.musement.com`)
   - **Результат**: Возвращает HTML страницу "Page not found"
   - **Вывод**: API требует специфических эндпоинтов и аутентификации

3. **Проверка документации** (`https://partner-api.musement.com`)
   - **Результат**: Полностью доступна и детализирована
   - **Вывод**: Документация публична и хорошо структурирована

### Созданные демонстрационные материалы

1. **Python скрипт** (`musement_api_demo.py`)
   - Демонстрирует структуру запросов
   - Показывает процесс аутентификации
   - Включает примеры основных операций

2. **Bash скрипт** (`musement_curl_demo.sh`)
   - Содержит готовые curl команды
   - Показывает все необходимые заголовки
   - Демонстрирует различные типы запросов

## Ключевые особенности API

### Безопасность
- Обязательная OAuth 2.0 аутентификация
- Токены с ограниченным временем жизни (1 час)
- Обязательные заголовки для всех запросов

### Scopes (Области доступа)
- `comment` - разрешение на отправку отзывов об активности
- `no-payment` - разрешение на использование "no-payment flow"
- `order-item-cancellation` - разрешение на отмену бронирований

### Версионирование
- Текущая версия: 3.4.0
- Обязательный заголовок `X-Musement-Version`

### Поддержка
- API distribution team: api-distribution@tui.com
- Business support: business-support@musement.com

## Рекомендации для интеграции

### Для начинающих партнеров

1. **Начните с контакта Strategic partnerships**
   - Email: business@musement.com
   - Обсудите бизнес-модель и требования

2. **Выберите тип интеграции**
   - Affiliate для быстрого старта
   - Merchant для полного контроля

3. **Подготовьтесь к sandbox тестированию**
   - Изучите документацию
   - Подготовьте тестовую среду

### Технические рекомендации

1. **Управление токенами**
   - Реализуйте автоматическое обновление токенов
   - Отслеживайте время истечения через `expires_in`

2. **Обработка ошибок**
   - Реализуйте retry логику для временных сбоев
   - Обрабатывайте различные HTTP статус коды

3. **Кэширование**
   - Кэшируйте справочные данные (города, страны, категории)
   - Учитывайте TTL для различных типов данных

4. **Мониторинг**
   - Отслеживайте производительность API
   - Логируйте все запросы для отладки

## Заключение

API Musement Partner представляет собой мощный и хорошо документированный инструмент для интеграции с каталогом активностей Musement. Основным барьером для начала работы является необходимость официального партнерства и получения credentials.

**Преимущества**:
- Подробная документация
- Гибкие типы интеграции
- Богатый функционал поиска и фильтрации
- Поддержка полного цикла бронирования

**Ограничения**:
- Требует официального партнерства
- Нет публичных эндпоинтов для тестирования
- Сложный процесс получения доступа

**Следующие шаги**:
Для реального использования API необходимо связаться с командой Musement по адресу business@musement.com и начать процесс оформления партнерства.

